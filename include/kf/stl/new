#pragma once

#pragma warning(push)
#pragma warning(disable : 4595) // non-member operator new or delete functions may not be declared inline
#pragma warning(disable : 4996) // TODO: ExAllocatePoolWithTag is deprecated, use ExAllocatePool2

inline void* __cdecl operator new(size_t size, POOL_TYPE poolType) noexcept
{
    if (size > 0)
    {
#pragma warning(suppress: 28160) // Must succeed pool allocations are forbidden. Allocation failures cause a system crash.
        return ::ExAllocatePoolWithTag(poolType, size == 0 ? 1 : size, 'n++C');
    }
    return nullptr;
}

inline void __cdecl operator delete(void* ptr) noexcept
{
    ::ExFreePoolWithTag(ptr, 'n++C');
}

inline void __cdecl operator delete[](void* ptr) noexcept
{
    ::ExFreePoolWithTag(ptr, 'n++C');
}

// size-aware deallocation
inline void __cdecl operator delete(void* ptr, size_t) noexcept
{
    operator delete(ptr);
}

// To avoid warning C4291: 'void *operator new(size_t,POOL_TYPE) noexcept':
// no matching operator delete found; memory will not be freed if initialization throws an exception
inline void operator delete(void* ptr, POOL_TYPE) noexcept
{
    operator delete(ptr);
}

#pragma warning(pop)
